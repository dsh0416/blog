<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>在 Ruby 中实现一个 WebSocket 掩码 - Coderemixer 代码混音师</title>
<meta name="description" content="引">


  <meta name="author" content="CodeRemixer">
  
  <meta property="article:author" content="CodeRemixer">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Coderemixer 代码混音师">
<meta property="og:title" content="在 Ruby 中实现一个 WebSocket 掩码">
<meta property="og:url" content="https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang">


  <meta property="og:description" content="引">







  <meta property="article:published_time" content="2018-07-10T21:47:45+00:00">






<link rel="canonical" href="https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://coderemixer.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Coderemixer 代码混音师 Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>


  
    <script src="/assets/js/mathjax.js"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Coderemixer 代码混音师
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">首页</a>
            </li><li class="masthead__menu-item">
              <a href="/about">关于</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/dsh0416">GitHub</a>
            </li><li class="masthead__menu-item">
              <a href="https://twitter.com/DeltonDing">X</a>
            </li><li class="masthead__menu-item">
              <a href="/atom.xml">RSS</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio-photo.png" alt="CodeRemixer" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">CodeRemixer</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>一个用来发牢骚的网站，以至于无法对所说的话负责。<br /><br /> 文章若无特别声明，皆采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 进行许可。</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="在 Ruby 中实现一个 WebSocket 掩码">
    <meta itemprop="description" content="引">
    <meta itemprop="datePublished" content="2018-07-10T21:47:45+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">在 Ruby 中实现一个 WebSocket 掩码
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2018-07-10T21:47:45+00:00">July 10, 2018</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h2 id="引">引</h2>

<p>在 WebSocket 协议中有一个重要的实现就是 masking（掩码），根据 RFC 6455 <a href="https://tools.ietf.org/html/rfc6455#section-10.3">10.3 章节</a> 的讨论，客户端连接服务器必须要打开掩码功能，当服务器收到一个客户端帧没有打开掩码时，应到立刻终止这一连接。关于为什么必须有一方开启 mask，可以参见 <a href="https://security.stackexchange.com/questions/36930/how-does-websocket-frame-masking-protect-against-cache-poisoning">这个回答</a>。</p>

<p>一个 WebSocket 帧长成下面这样：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-------+-+-------------+-------------------------------+
     |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
     |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
     |N|V|V|V|       |S|             |   (if payload len==126/127)   |
     | |1|2|3|       |K|             |                               |
     +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
     |     Extended payload length continued, if payload len == 127  |
     + - - - - - - - - - - - - - - - +-------------------------------+
     |                               |Masking-key, if MASK set to 1  |
     +-------------------------------+-------------------------------+
     | Masking-key (continued)       |          Payload Data         |
     +-------------------------------- - - - - - - - - - - - - - - - +
     :                     Payload Data continued ...                :
     + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
     |                     Payload Data continued ...                |
     +---------------------------------------------------------------+
</code></pre></div></div>

<p>举例来说：</p>

<p>当客户端向服务器发送一个 “Hello” 字符串的时候，二进制流长成下面这样：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x81 0x85 0x37 0xfa 0x21 0x3d 0x7f 0x9f 0x4d 0x51 0x58
</code></pre></div></div>

<p>其中：</p>

<ul>
  <li>第一个 Byte 0x81，也就是 0b10000001，指的是 FIN=1，代表这帧传输了完整的数据，没有分片。Opcode 是 0x1，传输的是一个字符串。</li>
  <li>第二个 Byte 0x85，也就是 0b10000101，指使用 Mask，Payload 的长度是 5。</li>
  <li>第三到第六个 Byte 是 Mask 掩码 Key。</li>
  <li>第七到十一个 Byte 原先是 0x48(H) 0x65(e) 0x6c(l) 0x6c(l) 0x6f(o)，但现在要被掩码盖住，掩码的计算方式就是循环进行异或运算。解码时只需要对着 Mask Key 再做一次异或就会回去，因为 a ^ b ^ b = a。
    <ul>
      <li>0x48 ^ 0x37 = 0x7f</li>
      <li>0x65 ^ 0xfa = 0x9f</li>
      <li>0x6c ^ 0x21 = 0x4d</li>
      <li>0x6c ^ 0x3d = 0x51</li>
      <li>0x6f ^ 0x37 = 0x58</li>
    </ul>
  </li>
</ul>

<p>这个过程在 Ruby 中应该怎么实现呢？</p>

<h2 id="尝试">尝试</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stream</span> <span class="o">=</span> <span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span><span class="p">([</span><span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">].</span><span class="nf">pack</span><span class="p">(</span><span class="s1">'C*'</span><span class="p">))</span> <span class="c1"># 模拟网络传进来的 byte 流</span>

<span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="n">first_byte</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">getbyte</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="n">first_byte</span> <span class="o">&amp;</span> <span class="mb">0b0001111</span> <span class="c1"># 先不考虑 fin</span>

  <span class="n">second_byte</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">getbyte</span>
  <span class="k">raise</span> <span class="s1">'NotMaskedError'</span> <span class="k">unless</span> <span class="p">(</span><span class="n">second_byte</span> <span class="o">&amp;</span> <span class="mb">0b10000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">128</span>

  <span class="n">payload</span> <span class="o">=</span> <span class="n">second_byte</span> <span class="o">&amp;</span> <span class="mb">0b01111111</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="p">.</span><span class="nf">getbyte</span> <span class="p">}</span>
  <span class="n">masked_msg</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="p">.</span><span class="nf">getbyte</span> <span class="p">}</span>

  <span class="c1"># Start Decoding</span>
  <span class="n">masked_msg</span> <span class="o">=</span> <span class="n">masked_msg</span><span class="p">.</span><span class="nf">map</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">byte</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
    <span class="n">byte</span> <span class="o">^</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">return</span> <span class="n">masked_msg</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="s1">'C*'</span><span class="p">)</span> <span class="k">if</span> <span class="p">[</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">].</span><span class="nf">include?</span> <span class="n">opcode</span> <span class="c1"># String message</span>
  <span class="k">return</span> <span class="n">masked_msg</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">mask</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="c1"># =&gt; Hello</span>
</code></pre></div></div>

<p>Bravo! 我们正确实现了解码过程，这段代码的性能如何呢？</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'benchmark'</span>

<span class="no">N</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span> <span class="p">{</span> <span class="no">N</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="n">mask</span><span class="p">(</span><span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span><span class="p">([</span><span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">].</span><span class="nf">pack</span><span class="p">(</span><span class="s1">'C*'</span><span class="p">)))</span> <span class="k">end</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       user     system      total        real
   5.083038   0.025399   5.108437 (  5.154494)
</code></pre></div></div>

<p>emmm… 处理 1000 万个 byte 就这种性能… 恐怕用 WebSocket 做实时通讯不太行啊。</p>

<p>不过 <a href="http://en.wikipedia.org/wiki/Donald_Knuth">Donald Knuth</a> 说过：「我们应该忘记细小的性能提升，在 97% 的情况下，过早的优化都是万恶之源。」</p>

<p><strong>好了，收工回家了。</strong></p>

<p>（完）</p>

<h2 id="才怪">才怪</h2>

<p>高德纳还说过：「我们千万不能放弃剩下的 3%」而解码过程是每个请求都必须跑的，对于一个 I/O-bound 的 Web 应用，如果因为一个 decode 变成 CPU-bound 那可是个非常严重的问题，能优化一点都有很大的帮助。</p>

<p>于是，要想给一段代码找到性能问题，第一个想到的工具当然就是：</p>

<p><strong>profiler</strong> !!!</p>

<p>要在 Ruby 上使用 profiler 很简单，只需要引入 profile 库即可。不过 profiler 会让程序运行得很慢，要注意节制在潜在的性能问题上去单独跑。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby <span class="nt">-rprofile</span> test.rb
</code></pre></div></div>

<p>报告如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  %   cumulative   self              self     total
 time   seconds   seconds    calls  ms/call  ms/call  name
 49.28     2.94      2.94   150000     0.02     0.05  Object#mask
 11.59     3.63      0.69    20000     0.03     0.09  Array#initialize
  7.05     4.05      0.42    20000     0.02     0.10  Array#map
  5.65     4.39      0.34   110000     0.00     0.00  StringIO#getbyte
  4.16     4.64      0.25    10002     0.02     1.78  nil#
  3.37     4.84      0.20    20002     0.01     0.10  Class#new
  2.62     5.00      0.16    50000     0.00     0.00  Array#[]
  2.60     5.15      0.16    50000     0.00     0.00  Integer#^
  2.53     5.30      0.15    50000     0.00     0.00  Integer#%
  1.77     5.41      0.11    10001     0.01     0.01  StringIO#initialize
  1.75     5.51      0.10    10000     0.01     0.21  Enumerator#with_index
  1.73     5.62      0.10    10001     0.01     0.02  StringIO.new
  1.57     5.71      0.09    30000     0.00     0.00  Integer#&amp;
  1.41     5.79      0.08    20001     0.00     0.00  Array#pack
  1.26     5.87      0.08        1    75.09  5962.83  Integer#times
  0.53     5.90      0.03    10000     0.00     0.00  Array#include?
  0.52     5.93      0.03    10000     0.00     0.00  Integer#==
  0.52     5.96      0.03    10001     0.00     0.00  BasicObject#initialize
...
</code></pre></div></div>

<p>这个 profiler 结果是我们最不愿意看到的，因为各个方法都平均地散落在哪里，并没有哪个方法特别占用时间。面对这种情况我们该怎么做呢？</p>

<h2 id="aot">AOT？</h2>

<p>由于我们的操作几乎都是位操作，而以对象为单位来操作大大增加了各种开销。也许等之后 2.6.0 Ruby 有 JIT 的话，也许会随着跑的时间变长而优化，不过。。。我们可以 AOT 编译这些代码啊。</p>

<p>什么？你问 Ruby 什么时候支持 AOT 了？</p>

<p>Ruby 不支持，你自己判断这段代码是瓶颈，自己把这段代码写成 C 语言编译到二进制不就是 AOT 了？</p>

<p>在这篇 <a href="https://blog.jcoglan.com/2012/07/29/your-first-ruby-native-extension-c/">博客</a> 中作者介绍了他是如何通过实现 C 扩展来提升 Faye WebSocket 的性能的。按这个思路，我之前对 <a href="https://github.com/midori-rb/midori.rb">Midori</a> 库中 WebSocket 的 Mask 是类似实现的：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;ruby.h&gt;</span><span class="cp">
</span>
<span class="n">VALUE</span> <span class="n">WebSocket</span> <span class="o">=</span> <span class="n">Qnil</span><span class="p">;</span>
<span class="n">VALUE</span> <span class="n">MidoriWebSocket</span> <span class="o">=</span> <span class="n">Qnil</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">Init_midori_ext</span><span class="p">();</span>
<span class="n">VALUE</span> <span class="nf">method_midori_websocket_mask</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">self</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">payload</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">mask</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">Init_midori_ext</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Midori</span> <span class="o">=</span> <span class="n">rb_define_module</span><span class="p">(</span><span class="s">"Midori"</span><span class="p">);</span>
  <span class="n">MidoriWebSocket</span> <span class="o">=</span> <span class="n">rb_define_class_under</span><span class="p">(</span><span class="n">Midori</span><span class="p">,</span> <span class="s">"WebSocket"</span><span class="p">,</span> <span class="n">rb_cObject</span><span class="p">);</span>
  <span class="n">rb_define_protected_method</span><span class="p">(</span><span class="n">MidoriWebSocket</span><span class="p">,</span> <span class="s">"mask"</span><span class="p">,</span> <span class="n">method_midori_websocket_mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">VALUE</span> <span class="nf">method_midori_websocket_mask</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">self</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">payload</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">VALUE</span> <span class="n">unmasked</span> <span class="o">=</span> <span class="n">rb_ary_new2</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">mask_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">))};</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mask_array</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">];</span>
    <span class="n">rb_ary_store</span><span class="p">(</span><span class="n">unmasked</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">INT2NUM</span><span class="p">(</span><span class="n">p</span> <span class="o">^</span> <span class="n">m</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">unmasked</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>从理论上讲，这很好的减少了各种内存的分配，应该快很多，那么到底快了多少呢？</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       user     system      total        real
   5.293516   0.044790   5.338306 (  5.442116)
   4.627439   0.023852   4.651291 (  4.699278)
</code></pre></div></div>

<p>1.16x 的速度。</p>

<h2 id="能不能快一点">能不能快一点？</h2>

<p>写 Ruby 上的 C 扩展一个比较麻烦的地方就在于这些 VALUE，VALUE 其实是一个指向 Ruby 对象的 uintptr_t 指针。如果我们减少对 Ruby 对象本身的调用，减少一些中间过程，理论上应该会更快。比如说，当我们发现 0x1 0x9 0xA 的 Opcode 是字符串类型，我们便可以不去创建 RARRAY 类型，而直接将字符串类型返回回去。</p>

<p>于是我们可以再实现一个 C 扩展函数：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;ruby.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ruby/encoding.h&gt;</span><span class="cp">
</span>
<span class="n">VALUE</span> <span class="n">Midori</span> <span class="o">=</span> <span class="n">Qnil</span><span class="p">;</span>
<span class="n">VALUE</span> <span class="n">MidoriWebSocket</span> <span class="o">=</span> <span class="n">Qnil</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">Init_midori_ext</span><span class="p">();</span>
<span class="n">VALUE</span> <span class="nf">method_midori_websocket_mask</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">self</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">payload</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">mask</span><span class="p">);</span>
<span class="n">VALUE</span> <span class="nf">method_midori_websocket_mask_str</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">self</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">payload</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">mask</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">Init_midori_ext</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Midori</span> <span class="o">=</span> <span class="n">rb_define_module</span><span class="p">(</span><span class="s">"Midori"</span><span class="p">);</span>
  <span class="n">MidoriWebSocket</span> <span class="o">=</span> <span class="n">rb_define_class_under</span><span class="p">(</span><span class="n">Midori</span><span class="p">,</span> <span class="s">"WebSocket"</span><span class="p">,</span> <span class="n">rb_cObject</span><span class="p">);</span>
  <span class="n">rb_define_protected_method</span><span class="p">(</span><span class="n">MidoriWebSocket</span><span class="p">,</span> <span class="s">"mask"</span><span class="p">,</span> <span class="n">method_midori_websocket_mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">rb_define_protected_method</span><span class="p">(</span><span class="n">MidoriWebSocket</span><span class="p">,</span> <span class="s">"mask_str"</span><span class="p">,</span> <span class="n">method_midori_websocket_mask_str</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">VALUE</span> <span class="nf">method_midori_websocket_mask</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">self</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">payload</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">VALUE</span> <span class="n">unmasked</span> <span class="o">=</span> <span class="n">rb_ary_new2</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">mask_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">))};</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mask_array</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">];</span>
    <span class="n">rb_ary_store</span><span class="p">(</span><span class="n">unmasked</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">INT2NUM</span><span class="p">(</span><span class="n">p</span> <span class="o">^</span> <span class="n">m</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">unmasked</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VALUE</span> <span class="nf">method_midori_websocket_mask_str</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">self</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">payload</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>

  <span class="kt">int</span> <span class="n">mask_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
      <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">))};</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">NUM2INT</span><span class="p">(</span><span class="n">rb_ary_entry</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mask_array</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">];</span>
    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">^</span> <span class="n">m</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">rb_enc_str_new</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb_utf8_encoding</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       user     system      total        real
   5.372697   0.044040   5.416737 (  5.502921)
   4.994706   0.047653   5.042359 (  5.147833)
   3.745804   0.015971   3.761775 (  3.796537)
</code></pre></div></div>

<p>这下，我们得到了 45% 的性能提升，这是个好开始。</p>

<h2 id="what-if">What if…</h2>

<p>既然我们知道减少和 Ruby 对象的交互可以增加性能，如果我们把整个 decode 过程都用 C 实现一遍会怎么样呢？</p>

<pre><code class="language-C">#include &lt;ruby.h&gt;
#include &lt;ruby/encoding.h&gt;

VALUE Midori = Qnil;
VALUE MidoriWebSocket = Qnil;

void Init_midori_ext();
VALUE method_midori_websocket_mask(VALUE self, VALUE payload, VALUE mask);
VALUE method_midori_websocket_mask_str(VALUE self, VALUE payload, VALUE mask);
VALUE method_midori_websocket_decode_c(VALUE self, VALUE data);

void Init_midori_ext()
{
  Midori = rb_define_module("Midori");
  MidoriWebSocket = rb_define_class_under(Midori, "WebSocket", rb_cObject);
  rb_define_protected_method(MidoriWebSocket, "mask", method_midori_websocket_mask, 2);
  rb_define_protected_method(MidoriWebSocket, "mask_str", method_midori_websocket_mask_str, 2);
  rb_define_method(MidoriWebSocket, "decode_c", method_midori_websocket_decode_c, 1);
}

VALUE method_midori_websocket_mask(VALUE self, VALUE payload, VALUE mask)
{
  long n = RARRAY_LEN(payload), i, p, m;
  VALUE unmasked = rb_ary_new2(n);

  int mask_array[] = {
      NUM2INT(rb_ary_entry(mask, 0)),
      NUM2INT(rb_ary_entry(mask, 1)),
      NUM2INT(rb_ary_entry(mask, 2)),
      NUM2INT(rb_ary_entry(mask, 3))};

  for (i = 0; i &lt; n; i++)
  {
    p = NUM2INT(rb_ary_entry(payload, i));
    m = mask_array[i % 4];
    rb_ary_store(unmasked, i, INT2NUM(p ^ m));
  }
  return unmasked;
}

VALUE method_midori_websocket_mask_str(VALUE self, VALUE payload, VALUE mask)
{
  long n = RARRAY_LEN(payload), i, p, m;
  char result[n];

  int mask_array[] = {
      NUM2INT(rb_ary_entry(mask, 0)),
      NUM2INT(rb_ary_entry(mask, 1)),
      NUM2INT(rb_ary_entry(mask, 2)),
      NUM2INT(rb_ary_entry(mask, 3))};

  for (i = 0; i &lt; n; i++)
  {
    p = NUM2INT(rb_ary_entry(payload, i));
    m = mask_array[i % 4];
    result[i] = p ^ m;
  }

  return rb_enc_str_new(result, n, rb_utf8_encoding());
}

VALUE method_midori_websocket_decode_c(VALUE self, VALUE data)
{
  int byte, opcode;
  ID getbyte = rb_intern("getbyte");

  byte = NUM2INT(rb_funcall(data, getbyte, 0));
  opcode = byte &amp; 0xf;

  byte = NUM2INT(rb_funcall(data, getbyte, 0));
  if ((byte &amp; 0x80) != 0x80)
  {
    rb_raise(rb_eRuntimeError, "NotMaskedError");
  }

  int n = byte &amp; 0x7f;
  char result[n];

  int mask_array[] = {
      NUM2INT(rb_funcall(data, getbyte, 0)),
      NUM2INT(rb_funcall(data, getbyte, 0)),
      NUM2INT(rb_funcall(data, getbyte, 0)),
      NUM2INT(rb_funcall(data, getbyte, 0))};

  for (int i = 0; i &lt; n; i++)
  {
    result[i] = NUM2INT(rb_funcall(data, getbyte, 0)) ^ mask_array[i % 4];
  }

  if (opcode == 0x1 || opcode == 0x9 || opcode == 0xA)
    return rb_enc_str_new(result, n, rb_utf8_encoding());

  VALUE result_arr = rb_ary_new2(n);
  for (int i = 0; i &lt; n; i++)
  {
    rb_ary_store(result_arr, i, INT2NUM(result[i]));
  }
  return result_arr;
}

</code></pre>

<p>跑一下 benchmark：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       user     system      total        real
   5.020994   0.029096   5.050090 (  5.108254)
   4.836846   0.035304   4.872150 (  4.953138)
   3.826166   0.021345   3.847511 (  3.892810)
   2.021958   0.014087   2.036045 (  2.066971)
</code></pre></div></div>

<p>2.47x 速度，至此，我们将解码速度提高了 147%。</p>

<h2 id="副作用">副作用</h2>

<p>然而显然，用 C 语言来写这样的代码安全性是很难保证的。特别是大家的 C 语言水平通常都不会太高超，一不小心来个内存泄漏分分钟就 gg 了。大多数时候，我们解决的性能问题都不是直接封装成库，如果是企业内部用，那么我们可以对编译过程提一些要求。一个比较有趣的尝试是 Rust 上的 <a href="https://usehelix.com/">helix</a>。可以在保障内存安全的情况下写一些辅助函数，并且通过 Rust 宏的支持下，使得代码也没有 C 语言那么难看。</p>

<p>如果在你的业务场景中也有遇到运算密集（注意不是 I/O 密集瓶颈）时，通过 profiler 确认，不妨也可以试试用 C 扩展来实现一下吧！</p>

<p>最后留一个小问题，如果收到的 WebSocket 流非常长，能不能通过什么魔法使得编译器优化过程中触发 CPU 的 SIMD 特性，从而得到更快的速度呢？</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/ruby" class="page__taxonomy-item" rel="tag">Ruby</a><span class="sep">, </span>
    
      <a href="/tags/%E7%BC%96%E7%A8%8B" class="page__taxonomy-item" rel="tag">编程</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-07-10T21:47:45+00:00">July 10, 2018</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=%E5%9C%A8+Ruby+%E4%B8%AD%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA+WebSocket+%E6%8E%A9%E7%A0%81%20https%3A%2F%2Fcoderemixer.com%2F2018%2F07%2F10%2Fruby-websocket-in-c-lang" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fcoderemixer.com%2F2018%2F07%2F10%2Fruby-websocket-in-c-lang" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fcoderemixer.com%2F2018%2F07%2F10%2Fruby-websocket-in-c-lang" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2018/07/03/ruby-inline-private-method" class="pagination--pager" title="Ruby 内联私有方法与原理
">Previous</a>
    
    
      <a href="/2018/11/24/how-to-use-fonts" class="pagination--pager" title="使用字体，怎样不惹官司
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2024/04/30/tokyo-metro-2023" rel="permalink">一个熟悉又陌生的解谜游戏 —— 东京地下铁 2023 解谜游戏设计分析
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2024-04-30T15:39:32+00:00">April 30, 2024</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">2019 年我写过一篇《平成最后的烂尾游戏——东京地下铁 2018 解谜游戏设计分析》。2020 年因为 COVID-19 的原因，没怎么敢出门错过了 Tokyo Metro 地下谜 2019。 有人说我其实玩过 2019，并且还解得很快… 但我竟然一点印象都没有了。而 2021 年的地下谜又被取消了，乘着 20...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2021/07/05/compile-malay-tea-name" rel="permalink">三点几嚟，饮茶先啦 —— 将大马饮料名编译成汉语
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-07-05T12:44:49+00:00">July 5, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">近几日马来西亚网友 Gurdip Singh 在 Facebook 发的这个「三点几嚟，饮茶先啦」非常流行。
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2021/01/08/autopilot-with-ruby" rel="permalink">用 Ruby 实现飞机自动驾驶仪
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-01-08T13:03:32+00:00">January 8, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">krpc 是一个砍巴拉太空计划（Kerbel Space Program）中的插件。可以通过 RPC 来控制游戏。同时有第三方的 Ruby 客户端：krpc-rb。和真实飞机不同的是，在砍巴拉游戏中驾驶飞机是非常痛苦的，在没有插件辅助的情况下，你看不到具体的 GPS 坐标，很多时候看到的都是和飞机驾驶无关的轨道参...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2020/12/22/ruby-3-fiber-scheduler-evt-dev-log" rel="permalink">为 Ruby 3 Fiber 调度器设计事件库 Evt
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2020-12-22T17:41:41+00:00">December 22, 2020</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">For English Readers
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Coderemixer 代码混音师. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/2018/07/10/ruby-websocket-in-c-lang"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://coderemixer.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
