<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="引在 WebSocket 协议中有一个重要的实现就是 masking（掩码），根据 RFC 6455 10.3 章节 的讨论，客户端连接服务器必须要打开掩码功能，当服务器收到一个客户端帧没有打开掩码时，应到立刻终止这一连接。关于为什么必须有一方开启 mask，可以参见 这个回答。 一个 WebSocket 帧长成下面这样： 123456789101112131415161718 0">
<meta property="og:type" content="article">
<meta property="og:title" content="在 Ruby 中实现一个 WebSocket 掩码">
<meta property="og:url" content="https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/index.html">
<meta property="og:site_name" content="代码混音师">
<meta property="og:description" content="引在 WebSocket 协议中有一个重要的实现就是 masking（掩码），根据 RFC 6455 10.3 章节 的讨论，客户端连接服务器必须要打开掩码功能，当服务器收到一个客户端帧没有打开掩码时，应到立刻终止这一连接。关于为什么必须有一方开启 mask，可以参见 这个回答。 一个 WebSocket 帧长成下面这样： 123456789101112131415161718 0">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-07-10T12:47:45.000Z">
<meta property="article:modified_time" content="2020-08-12T09:01:06.006Z">
<meta property="article:author" content="CodeRemixer">
<meta property="article:tag" content="Ruby">
<meta property="article:tag" content="编程">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>在 Ruby 中实现一个 WebSocket 掩码</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="代码混音师" type="application/atom+xml" />
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/10/21/ruby-native-ext-compass/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/07/03/ruby-inline-private-method/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&text=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&is_video=false&description=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=在 Ruby 中实现一个 WebSocket 掩码&body=Check out this article: https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&name=在 Ruby 中实现一个 WebSocket 掩码&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&t=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引"><span class="toc-number">1.</span> <span class="toc-text">引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#尝试"><span class="toc-number">2.</span> <span class="toc-text">尝试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#才怪"><span class="toc-number">3.</span> <span class="toc-text">才怪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOT？"><span class="toc-number">4.</span> <span class="toc-text">AOT？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#能不能快一点？"><span class="toc-number">5.</span> <span class="toc-text">能不能快一点？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-if…"><span class="toc-number">6.</span> <span class="toc-text">What if…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#副作用"><span class="toc-number">7.</span> <span class="toc-text">副作用</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        在 Ruby 中实现一个 WebSocket 掩码
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">代码混音师</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-07-10T12:47:45.000Z" itemprop="datePublished">2018-07-10</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Ruby/" rel="tag">Ruby</a>, <a class="tag-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="引"><a href="#引" class="headerlink" title="引"></a>引</h2><p>在 WebSocket 协议中有一个重要的实现就是 masking（掩码），根据 RFC 6455 <a href="https://tools.ietf.org/html/rfc6455#section-10.3" target="_blank" rel="noopener">10.3 章节</a> 的讨论，客户端连接服务器必须要打开掩码功能，当服务器收到一个客户端帧没有打开掩码时，应到立刻终止这一连接。关于为什么必须有一方开启 mask，可以参见 <a href="https://security.stackexchange.com/questions/36930/how-does-websocket-frame-masking-protect-against-cache-poisoning" target="_blank" rel="noopener">这个回答</a>。</p>
<p>一个 WebSocket 帧长成下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16&#x2F;64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len&#x3D;&#x3D;126&#x2F;127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len &#x3D;&#x3D; 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>举例来说：</p>
<p>当客户端向服务器发送一个 “Hello” 字符串的时候，二进制流长成下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x81 0x85 0x37 0xfa 0x21 0x3d 0x7f 0x9f 0x4d 0x51 0x58</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>第一个 Byte 0x81，也就是 0b10000001，指的是 FIN=1，代表这帧传输了完整的数据，没有分片。Opcode 是 0x1，传输的是一个字符串。</li>
<li>第二个 Byte 0x85，也就是 0b10000101，指使用 Mask，Payload 的长度是 5。</li>
<li>第三到第六个 Byte 是 Mask 掩码 Key。</li>
<li>第七到十一个 Byte 原先是 0x48(H) 0x65(e) 0x6c(l) 0x6c(l) 0x6f(o)，但现在要被掩码盖住，掩码的计算方式就是循环进行异或运算。解码时只需要对着 Mask Key 再做一次异或就会回去，因为 a ^ b ^ b = a。<ul>
<li>0x48 ^ 0x37 = 0x7f</li>
<li>0x65 ^ 0xfa = 0x9f</li>
<li>0x6c ^ 0x21 = 0x4d</li>
<li>0x6c ^ 0x3d = 0x51</li>
<li>0x6f ^ 0x37 = 0x58</li>
</ul>
</li>
</ul>
<p>这个过程在 Ruby 中应该怎么实现呢？</p>
<h2 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">stream = StringIO.new([<span class="number">0x81</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xfa</span>, <span class="number">0x21</span>, <span class="number">0x3d</span>, <span class="number">0x7f</span>, <span class="number">0x9f</span>, <span class="number">0x4d</span>, <span class="number">0x51</span>, <span class="number">0x58</span>].pack(<span class="string">'C*'</span>)) <span class="comment"># 模拟网络传进来的 byte 流</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mask</span><span class="params">(data)</span></span></span><br><span class="line">  first_byte = data.getbyte</span><br><span class="line">  opcode = first_byte &amp; 0b0001111 <span class="comment"># 先不考虑 fin</span></span><br><span class="line"></span><br><span class="line">  second_byte = data.getbyte</span><br><span class="line">  raise <span class="string">'NotMaskedError'</span> <span class="keyword">unless</span> (second_byte &amp; 0b1000000<span class="number">0</span>) == <span class="number">128</span></span><br><span class="line"></span><br><span class="line">  payload = second_byte &amp; 0b01111111</span><br><span class="line">  mask = Array.new(<span class="number">4</span>) &#123; data.getbyte &#125;</span><br><span class="line">  masked_msg = Array.new(payload) &#123; data.getbyte &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Start Decoding</span></span><br><span class="line">  masked_msg = masked_msg.map.with_index <span class="keyword">do</span> <span class="params">|byte, i|</span></span><br><span class="line">    byte ^ mask[i % <span class="number">4</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> masked_msg.pack(<span class="string">'C*'</span>) <span class="keyword">if</span> [<span class="number">0x1</span>, <span class="number">0x9</span>, <span class="number">0xA</span>].<span class="keyword">include</span>? opcode <span class="comment"># String message</span></span><br><span class="line">  <span class="keyword">return</span> masked_msg</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">puts mask(stream) <span class="comment"># =&gt; Hello</span></span><br></pre></td></tr></table></figure>

<p>Bravo! 我们正确实现了解码过程，这段代码的性能如何呢？</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'benchmark'</span></span><br><span class="line"></span><br><span class="line">N = <span class="number">1_000_000</span></span><br><span class="line">Benchmark.bm <span class="keyword">do</span> <span class="params">|x|</span></span><br><span class="line">  x.report &#123; N.times <span class="keyword">do</span> mask(StringIO.new([<span class="number">0x81</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xfa</span>, <span class="number">0x21</span>, <span class="number">0x3d</span>, <span class="number">0x7f</span>, <span class="number">0x9f</span>, <span class="number">0x4d</span>, <span class="number">0x51</span>, <span class="number">0x58</span>].pack(<span class="string">'C*'</span>))) <span class="keyword">end</span> &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    user     system      total        real</span><br><span class="line">5.083038   0.025399   5.108437 (  5.154494)</span><br></pre></td></tr></table></figure>

<p>emmm… 处理 1000 万个 byte 就这种性能… 恐怕用 WebSocket 做实时通讯不太行啊。</p>
<p>不过 <a href="http://en.wikipedia.org/wiki/Donald_Knuth" target="_blank" rel="noopener">Donald Knuth</a> 说过：「我们应该忘记细小的性能提升，在 97% 的情况下，过早的优化都是万恶之源。」</p>
<p><strong>好了，收工回家了。</strong></p>
<p>（完）</p>
<h2 id="才怪"><a href="#才怪" class="headerlink" title="才怪"></a>才怪</h2><p>高德纳还说过：「我们千万不能放弃剩下的 3%」而解码过程是每个请求都必须跑的，对于一个 I/O-bound 的 Web 应用，如果因为一个 decode 变成 CPU-bound 那可是个非常严重的问题，能优化一点都有很大的帮助。</p>
<p>于是，要想给一段代码找到性能问题，第一个想到的工具当然就是：</p>
<p><strong>profiler</strong> !!!</p>
<p>要在 Ruby 上使用 profiler 很简单，只需要引入 profile 库即可。不过 profiler 会让程序运行得很慢，要注意节制在潜在的性能问题上去单独跑。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -rprofile test.rb</span><br></pre></td></tr></table></figure>

<p>报告如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  %   cumulative   self              self     total</span><br><span class="line"> time   seconds   seconds    calls  ms&#x2F;call  ms&#x2F;call  name</span><br><span class="line"> 49.28     2.94      2.94   150000     0.02     0.05  Object#mask</span><br><span class="line"> 11.59     3.63      0.69    20000     0.03     0.09  Array#initialize</span><br><span class="line">  7.05     4.05      0.42    20000     0.02     0.10  Array#map</span><br><span class="line">  5.65     4.39      0.34   110000     0.00     0.00  StringIO#getbyte</span><br><span class="line">  4.16     4.64      0.25    10002     0.02     1.78  nil#</span><br><span class="line">  3.37     4.84      0.20    20002     0.01     0.10  Class#new</span><br><span class="line">  2.62     5.00      0.16    50000     0.00     0.00  Array#[]</span><br><span class="line">  2.60     5.15      0.16    50000     0.00     0.00  Integer#^</span><br><span class="line">  2.53     5.30      0.15    50000     0.00     0.00  Integer#%</span><br><span class="line">  1.77     5.41      0.11    10001     0.01     0.01  StringIO#initialize</span><br><span class="line">  1.75     5.51      0.10    10000     0.01     0.21  Enumerator#with_index</span><br><span class="line">  1.73     5.62      0.10    10001     0.01     0.02  StringIO.new</span><br><span class="line">  1.57     5.71      0.09    30000     0.00     0.00  Integer#&amp;</span><br><span class="line">  1.41     5.79      0.08    20001     0.00     0.00  Array#pack</span><br><span class="line">  1.26     5.87      0.08        1    75.09  5962.83  Integer#times</span><br><span class="line">  0.53     5.90      0.03    10000     0.00     0.00  Array#include?</span><br><span class="line">  0.52     5.93      0.03    10000     0.00     0.00  Integer#&#x3D;&#x3D;</span><br><span class="line">  0.52     5.96      0.03    10001     0.00     0.00  BasicObject#initialize</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这个 profiler 结果是我们最不愿意看到的，因为各个方法都平均地散落在哪里，并没有哪个方法特别占用时间。面对这种情况我们该怎么做呢？</p>
<h2 id="AOT？"><a href="#AOT？" class="headerlink" title="AOT？"></a>AOT？</h2><p>由于我们的操作几乎都是位操作，而以对象为单位来操作大大增加了各种开销。也许等之后 2.6.0 Ruby 有 JIT 的话，也许会随着跑的时间变长而优化，不过。。。我们可以 AOT 编译这些代码啊。</p>
<p>什么？你问 Ruby 什么时候支持 AOT 了？</p>
<p>Ruby 不支持，你自己判断这段代码是瓶颈，自己把这段代码写成 C 语言编译到二进制不就是 AOT 了？</p>
<p>在这篇 <a href="https://blog.jcoglan.com/2012/07/29/your-first-ruby-native-extension-c/" target="_blank" rel="noopener">博客</a> 中作者介绍了他是如何通过实现 C 扩展来提升 Faye WebSocket 的性能的。按这个思路，我之前对 <a href="https://github.com/midori-rb/midori.rb" target="_blank" rel="noopener">Midori</a> 库中 WebSocket 的 Mask 是类似实现的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ruby.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">VALUE WebSocket = Qnil;</span><br><span class="line">VALUE MidoriWebSocket = Qnil;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_midori_ext</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_midori_ext</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Midori = rb_define_module(<span class="string">"Midori"</span>);</span><br><span class="line">  MidoriWebSocket = rb_define_class_under(Midori, <span class="string">"WebSocket"</span>, rb_cObject);</span><br><span class="line">  rb_define_protected_method(MidoriWebSocket, <span class="string">"mask"</span>, method_midori_websocket_mask, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> n = RARRAY_LEN(payload), i, p, m;</span><br><span class="line">  VALUE unmasked = rb_ary_new2(n);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> mask_array[] = &#123;</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">1</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">2</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">3</span>))&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    p = NUM2INT(rb_ary_entry(payload, i));</span><br><span class="line">    m = mask_array[i % <span class="number">4</span>];</span><br><span class="line">    rb_ary_store(unmasked, i, INT2NUM(p ^ m));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> unmasked;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从理论上讲，这很好的减少了各种内存的分配，应该快很多，那么到底快了多少呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    user     system      total        real</span><br><span class="line">5.293516   0.044790   5.338306 (  5.442116)</span><br><span class="line">4.627439   0.023852   4.651291 (  4.699278)</span><br></pre></td></tr></table></figure>

<p>1.16x 的速度。</p>
<h2 id="能不能快一点？"><a href="#能不能快一点？" class="headerlink" title="能不能快一点？"></a>能不能快一点？</h2><p>写 Ruby 上的 C 扩展一个比较麻烦的地方就在于这些 VALUE，VALUE 其实是一个指向 Ruby 对象的 uintptr_t 指针。如果我们减少对 Ruby 对象本身的调用，减少一些中间过程，理论上应该会更快。比如说，当我们发现 0x1 0x9 0xA 的 Opcode 是字符串类型，我们便可以不去创建 RARRAY 类型，而直接将字符串类型返回回去。</p>
<p>于是我们可以再实现一个 C 扩展函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ruby.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ruby/encoding.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">VALUE Midori = Qnil;</span><br><span class="line">VALUE MidoriWebSocket = Qnil;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_midori_ext</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span>;</span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask_str</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_midori_ext</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Midori = rb_define_module(<span class="string">"Midori"</span>);</span><br><span class="line">  MidoriWebSocket = rb_define_class_under(Midori, <span class="string">"WebSocket"</span>, rb_cObject);</span><br><span class="line">  rb_define_protected_method(MidoriWebSocket, <span class="string">"mask"</span>, method_midori_websocket_mask, <span class="number">2</span>);</span><br><span class="line">  rb_define_protected_method(MidoriWebSocket, <span class="string">"mask_str"</span>, method_midori_websocket_mask_str, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> n = RARRAY_LEN(payload), i, p, m;</span><br><span class="line">  VALUE unmasked = rb_ary_new2(n);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> mask_array[] = &#123;</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">1</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">2</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">3</span>))&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    p = NUM2INT(rb_ary_entry(payload, i));</span><br><span class="line">    m = mask_array[i % <span class="number">4</span>];</span><br><span class="line">    rb_ary_store(unmasked, i, INT2NUM(p ^ m));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> unmasked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask_str</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> n = RARRAY_LEN(payload), i, p, m;</span><br><span class="line">  <span class="keyword">char</span> result[n];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> mask_array[] = &#123;</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">1</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">2</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">3</span>))&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    p = NUM2INT(rb_ary_entry(payload, i));</span><br><span class="line">    m = mask_array[i % <span class="number">4</span>];</span><br><span class="line">    result[i] = p ^ m;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rb_enc_str_new(result, n, rb_utf8_encoding());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    user     system      total        real</span><br><span class="line">5.372697   0.044040   5.416737 (  5.502921)</span><br><span class="line">4.994706   0.047653   5.042359 (  5.147833)</span><br><span class="line">3.745804   0.015971   3.761775 (  3.796537)</span><br></pre></td></tr></table></figure>

<p>这下，我们得到了 45% 的性能提升，这是个好开始。</p>
<h2 id="What-if…"><a href="#What-if…" class="headerlink" title="What if…"></a>What if…</h2><p>既然我们知道减少和 Ruby 对象的交互可以增加性能，如果我们把整个 decode 过程都用 C 实现一遍会怎么样呢？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ruby.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ruby/encoding.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">VALUE Midori = Qnil;</span><br><span class="line">VALUE MidoriWebSocket = Qnil;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_midori_ext</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span>;</span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask_str</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span>;</span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_decode_c</span><span class="params">(VALUE self, VALUE data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_midori_ext</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Midori = rb_define_module(<span class="string">"Midori"</span>);</span><br><span class="line">  MidoriWebSocket = rb_define_class_under(Midori, <span class="string">"WebSocket"</span>, rb_cObject);</span><br><span class="line">  rb_define_protected_method(MidoriWebSocket, <span class="string">"mask"</span>, method_midori_websocket_mask, <span class="number">2</span>);</span><br><span class="line">  rb_define_protected_method(MidoriWebSocket, <span class="string">"mask_str"</span>, method_midori_websocket_mask_str, <span class="number">2</span>);</span><br><span class="line">  rb_define_method(MidoriWebSocket, <span class="string">"decode_c"</span>, method_midori_websocket_decode_c, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> n = RARRAY_LEN(payload), i, p, m;</span><br><span class="line">  VALUE unmasked = rb_ary_new2(n);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> mask_array[] = &#123;</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">1</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">2</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">3</span>))&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    p = NUM2INT(rb_ary_entry(payload, i));</span><br><span class="line">    m = mask_array[i % <span class="number">4</span>];</span><br><span class="line">    rb_ary_store(unmasked, i, INT2NUM(p ^ m));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> unmasked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_mask_str</span><span class="params">(VALUE self, VALUE payload, VALUE mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> n = RARRAY_LEN(payload), i, p, m;</span><br><span class="line">  <span class="keyword">char</span> result[n];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> mask_array[] = &#123;</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">1</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">2</span>)),</span><br><span class="line">      NUM2INT(rb_ary_entry(mask, <span class="number">3</span>))&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    p = NUM2INT(rb_ary_entry(payload, i));</span><br><span class="line">    m = mask_array[i % <span class="number">4</span>];</span><br><span class="line">    result[i] = p ^ m;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rb_enc_str_new(result, n, rb_utf8_encoding());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VALUE <span class="title">method_midori_websocket_decode_c</span><span class="params">(VALUE self, VALUE data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> byte, opcode;</span><br><span class="line">  ID getbyte = rb_intern(<span class="string">"getbyte"</span>);</span><br><span class="line"></span><br><span class="line">  byte = NUM2INT(rb_funcall(data, getbyte, <span class="number">0</span>));</span><br><span class="line">  opcode = byte &amp; <span class="number">0xf</span>;</span><br><span class="line"></span><br><span class="line">  byte = NUM2INT(rb_funcall(data, getbyte, <span class="number">0</span>));</span><br><span class="line">  <span class="keyword">if</span> ((byte &amp; <span class="number">0x80</span>) != <span class="number">0x80</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    rb_raise(rb_eRuntimeError, <span class="string">"NotMaskedError"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> n = byte &amp; <span class="number">0x7f</span>;</span><br><span class="line">  <span class="keyword">char</span> result[n];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> mask_array[] = &#123;</span><br><span class="line">      NUM2INT(rb_funcall(data, getbyte, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_funcall(data, getbyte, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_funcall(data, getbyte, <span class="number">0</span>)),</span><br><span class="line">      NUM2INT(rb_funcall(data, getbyte, <span class="number">0</span>))&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    result[i] = NUM2INT(rb_funcall(data, getbyte, <span class="number">0</span>)) ^ mask_array[i % <span class="number">4</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opcode == <span class="number">0x1</span> || opcode == <span class="number">0x9</span> || opcode == <span class="number">0xA</span>)</span><br><span class="line">    <span class="keyword">return</span> rb_enc_str_new(result, n, rb_utf8_encoding());</span><br><span class="line"></span><br><span class="line">  VALUE result_arr = rb_ary_new2(n);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    rb_ary_store(result_arr, i, INT2NUM(result[i]));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result_arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跑一下 benchmark：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    user     system      total        real</span><br><span class="line">5.020994   0.029096   5.050090 (  5.108254)</span><br><span class="line">4.836846   0.035304   4.872150 (  4.953138)</span><br><span class="line">3.826166   0.021345   3.847511 (  3.892810)</span><br><span class="line">2.021958   0.014087   2.036045 (  2.066971)</span><br></pre></td></tr></table></figure>

<p>2.47x 速度，至此，我们将解码速度提高了 147%。</p>
<h2 id="副作用"><a href="#副作用" class="headerlink" title="副作用"></a>副作用</h2><p>然而显然，用 C 语言来写这样的代码安全性是很难保证的。特别是大家的 C 语言水平通常都不会太高超，一不小心来个内存泄漏分分钟就 gg 了。大多数时候，我们解决的性能问题都不是直接封装成库，如果是企业内部用，那么我们可以对编译过程提一些要求。一个比较有趣的尝试是 Rust 上的 <a href="https://usehelix.com/" target="_blank" rel="noopener">helix</a>。可以在保障内存安全的情况下写一些辅助函数，并且通过 Rust 宏的支持下，使得代码也没有 C 语言那么难看。</p>
<p>如果在你的业务场景中也有遇到运算密集（注意不是 I/O 密集瓶颈）时，通过 profiler 确认，不妨也可以试试用 C 扩展来实现一下吧！</p>
<p>最后留一个小问题，如果收到的 WebSocket 流非常长，能不能通过什么魔法使得编译器优化过程中触发 CPU 的 SIMD 特性，从而得到更快的速度呢？</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引"><span class="toc-number">1.</span> <span class="toc-text">引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#尝试"><span class="toc-number">2.</span> <span class="toc-text">尝试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#才怪"><span class="toc-number">3.</span> <span class="toc-text">才怪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOT？"><span class="toc-number">4.</span> <span class="toc-text">AOT？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#能不能快一点？"><span class="toc-number">5.</span> <span class="toc-text">能不能快一点？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-if…"><span class="toc-number">6.</span> <span class="toc-text">What if…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#副作用"><span class="toc-number">7.</span> <span class="toc-text">副作用</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&text=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&is_video=false&description=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=在 Ruby 中实现一个 WebSocket 掩码&body=Check out this article: https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&title=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&name=在 Ruby 中实现一个 WebSocket 掩码&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://coderemixer.com/2018/07/10/ruby-websocket-in-c-lang/&t=在 Ruby 中实现一个 WebSocket 掩码" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2021
    CodeRemixer
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-127825283-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'coderemixer';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
