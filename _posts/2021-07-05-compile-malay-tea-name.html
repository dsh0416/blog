<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.25.1 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>三点几嚟，饮茶先啦 —— 将大马饮料名编译成汉语 - Coderemixer 代码混音师</title>
<meta name="description" content="一个用来发牢骚的网站，以至于无法对所说的话负责。">


  <meta name="author" content="CodeRemixer">
  
  <meta property="article:author" content="CodeRemixer">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Coderemixer 代码混音师">
<meta property="og:title" content="三点几嚟，饮茶先啦 —— 将大马饮料名编译成汉语">
<meta property="og:url" content="https://coderemixer.com/_posts/2021-07-05-compile-malay-tea-name">


  <meta property="og:description" content="一个用来发牢骚的网站，以至于无法对所说的话负责。">







  <meta property="article:published_time" content="2021-07-05T12:44:49+08:00">






<link rel="canonical" href="https://coderemixer.com/_posts/2021-07-05-compile-malay-tea-name">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://coderemixer.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Coderemixer 代码混音师 Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>


  
    <script src="/assets/js/mathjax.js"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Coderemixer 代码混音师
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">首页</a>
            </li><li class="masthead__menu-item">
              <a href="/about">关于</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/dsh0416">GitHub</a>
            </li><li class="masthead__menu-item">
              <a href="/atom.xml">RSS</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://coderemixer.com/">
        <img src="/assets/images/bio-photo.png" alt="CodeRemixer" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://coderemixer.com/" itemprop="url">CodeRemixer</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>一个用来发牢骚的网站，以至于无法对所说的话负责。<br /><br /> 文章若无特别声明，皆采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 进行许可。</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Shanghai ⊕ Tokyo</span>
        </li>
      

      
        
          
            <li><a href="mailto:dsh0416@gmail.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://github.com/dsh0416" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github-square" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://twitter.com/DeltonDing" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-square-x-twitter" aria-hidden="true"></i><span class="label">X (Twitter)</span></a></li>
          
        
          
            <li><a href="https://www.xiaohongshu.com/user/profile/6030b59300000000010044d5" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-square" aria-hidden="true"></i><span class="label">小红书</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="三点几嚟，饮茶先啦 —— 将大马饮料名编译成汉语">
    
    <meta itemprop="datePublished" content="2021-07-05T12:44:49+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://coderemixer.com/_posts/2021-07-05-compile-malay-tea-name" class="u-url" itemprop="url">三点几嚟，饮茶先啦 —— 将大马饮料名编译成汉语
</a>
          </h1>
          


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
        <p>近几日马来西亚网友 Gurdip Singh 在 Facebook 发的这个「三点几嚟，饮茶先啦」非常流行。</p>

<p>Facebook: www.facebook.com/100009201465316/videos/2530411593942198</p>

<p>Bilibili 搬运：https://www.bilibili.com/video/av845257746/</p>

<p>不过马来语的饮料名称非常有意思。某个目前居住在新加坡的朋友 @david92 给我解释了一下，如何在店里点茶喝。基本是一个组合式的语法，非常规律。最基础的茶底是红茶（Teh）或者咖啡（Kopi）。默认饮料是带糖和炼乳的，但你可以重新定制。如果你在后面加上 O 表示不要加炼乳，而 C 表示把炼乳换成鲜奶。类似，Kosong 是无糖，Siu Dai 是少糖，而 Gah Dai 是加更多的糖。</p>

<h2 id="ebnf-语法">ebnf 语法</h2>

<p>我查阅了一些资料进一步完善了一下这个概念，发现这个语法完全是「可编译」的，非常简单。很快，我写了一个 bnf 语法来描述这个概念：</p>

<pre><code class="language-ebnf">&lt;water&gt;     ::= "Kopi" | "Teh" | "Milo"
&lt;sugar&gt;     ::= "Kosong" | "Siu Dai" | "Gah Dai"
&lt;milk&gt;      ::= "O" | "C"
&lt;thickness&gt; ::= "Po" | "Gau"
&lt;extra&gt;     ::= "Peng" | "Bubble" | "Halia"
&lt;upsize&gt;    ::= "Nga Lat"
&lt;takeout&gt;   ::= "Bungkus" 
&lt;plastic&gt;   ::= "Ikat"
&lt;knot&gt;      ::= "Mati" | "Tepi"

&lt;drink&gt;     ::=
  (&lt;takeout&gt; (" " &lt;plastic&gt; (" " &lt;knot&gt;)?)? " ")?
  (&lt;upsize&gt; " ")?
  &lt;water&gt; (" " &lt;milk&gt;)? (" " &lt;sugar&gt;)?
  (" " &lt;thickness&gt;)?
  (" " &lt;extra&gt;)*
</code></pre>

<p>其中，Po 是清淡，Gau 是浓缩，Peng 是加冰块，Bubble 是加珍珠，Halia 是加姜汁。Nga Lat 是大杯。外带的概念比校复杂，Bungkus 是外带，通常是杯状的。像是 Bernard Tee 视频里那种塑料袋装的，叫 Ikat。Ikat 有两种不同的打结方式，一种是打死结 Mati，还有一种是侧面打结，开口的叫 Tepi。</p>

<p>比如 Bungkus Ikat Mati Nga Lat Kopi O Siu Dai Gau Peng Bubble 就是外带塑料袋装打死结大杯少糖浓缩咖啡加冰块和珍珠。</p>

<p>我们可以在 <a href="https://bnfplayground.pauliankline.com/">ebnf playground</a> 测试这个语法。这个网站甚至能生成随机的符合某个语法（比如这里 Drink）的字符串，来让我们人工检查这个语法对不对。于是截止这里我们还可以实现一个自动生成饮料名的生成器：https://www.bilibili.com/video/BV1SK4y197hc</p>

<h2 id="实现到汉语的编译器">实现到汉语的编译器</h2>

<p>Ruby 中有一个 gem 叫 ebnf 可以读取 ebnf 文件然后生成对应的 parser，然后我们写一个输出中文的 generator 即可将马来西亚语翻译成中文。</p>

<p>由于 ebnf 的语法并没有规范，Ruby ebnf 库和我们刚刚 playground 中的语法有细微不同，这里做了一些变更。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"ebnf"</span>

<span class="no">TEA_GRAMMER</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOF</span><span class="sh">
Water     ::= "Kopi" | "Teh" | "Milo"
Sugar     ::= "Kosong" | "Siu Dai" | "Gah Dai"
Milk      ::= "O" | "C"
Thickness ::= "Po" | "Gau"
Extra     ::= "Peng" | "Bubble" | "Halia"
Upsize    ::= "Nga Lat"
Knot      ::= "Mati" | "Tepi"
Plastic   ::= "Ikat" Knot?
Takeout   ::= "Bungkus" Plastic?

Drink     ::= Takeout? Upsize? Water Milk? Sugar? Thickness? Extra*
</span><span class="no">EOF</span>
</code></pre></div></div>

<p>由于这个库执行 parse 需要先转换成解析表达文法（Parsing Expression Grammar）从而生成更多的子规则，我们先打印一下自动生成的子规则便于之后开发 generator。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">EBNF</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="no">TEA_GRAMMER</span><span class="p">).</span><span class="nf">make_peg</span><span class="p">.</span><span class="nf">ast</span>

<span class="cm">=begin
(rule Water (alt "Kopi" "Teh" "Milo"))
(rule Sugar (alt "Kosong" "Siu Dai" "Gah Dai"))
(rule Milk (alt "O" "C"))
(rule Thickness (alt "Po" "Gau"))
(rule Extra (alt "Peng" "Bubble" "Halia"))
(rule Upsize (seq "Nga Lat"))
(rule Knot (alt "Mati" "Tepi"))
(rule Plastic (seq "Ikat" _Plastic_1))
(rule _Plastic_1 (opt Knot))
(rule Takeout (seq "Bungkus" _Takeout_1))
(rule _Takeout_1 (opt Plastic))
(rule Drink (seq _Drink_1 _Drink_2 Water _Drink_3 _Drink_4 _Drink_5 _Drink_6))
(rule _Drink_1 (opt Takeout))
(rule _Drink_2 (opt Upsize))
(rule _Drink_3 (opt Milk))
(rule _Drink_4 (opt Sugar))
(rule _Drink_5 (opt Thickness))
(rule _Drink_6 (star Extra))
=end</span>
</code></pre></div></div>

<p>我们创建一个 generator 类，如下：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MalayTea</span>
  <span class="kp">include</span> <span class="no">EBNF</span><span class="o">::</span><span class="no">PEG</span><span class="o">::</span><span class="no">Parser</span>
  <span class="nb">attr_reader</span> <span class="ss">:rules</span>
   <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@rules</span> <span class="o">=</span> <span class="no">EBNF</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="no">TEA_GRAMMER</span><span class="p">).</span><span class="nf">make_peg</span><span class="p">.</span><span class="nf">ast</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="n">parse</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="ss">:Drink</span><span class="p">,</span> <span class="vi">@rules</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="nb">p</span> <span class="no">MalayTea</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">(</span><span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span><span class="p">)</span>
</code></pre></div></div>

<p>这时候输入一个句子，其会如实输出 AST 抽象语法树。而我们要做的就是根据 rule 名称来规约这些语法树直到某个特定输出。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_1</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="s2">""</span>
    <span class="k">elsif</span> <span class="n">value</span><span class="p">.</span><span class="nf">length</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="s2">"外带"</span>
    <span class="k">else</span>
        <span class="s2">"外带</span><span class="si">#{</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">values</span><span class="p">.</span><span class="nf">join</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:Plastic</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="s2">""</span>
    <span class="k">elsif</span> <span class="n">value</span><span class="p">.</span><span class="nf">length</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="s2">"塑料袋装"</span>
    <span class="k">else</span>
        <span class="s2">"塑料袋装</span><span class="si">#{</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">values</span><span class="p">.</span><span class="nf">join</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:_Plastic_1</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="p">{</span> <span class="no">Mati</span><span class="p">:</span> <span class="s2">"打死结"</span><span class="p">,</span> <span class="no">Tepi</span><span class="p">:</span> <span class="s2">"侧面打结"</span><span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_2</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="s2">"大杯"</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:Water</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="p">{</span> <span class="no">Kopi</span><span class="p">:</span> <span class="s2">"咖啡"</span><span class="p">,</span> <span class="no">Teh</span><span class="p">:</span> <span class="s2">"红茶"</span><span class="p">,</span> <span class="no">Milo</span><span class="p">:</span> <span class="s2">"美禄"</span> <span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_3</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">"炼乳"</span> <span class="p">:</span> <span class="p">{</span> <span class="no">O</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="no">C</span><span class="p">:</span> <span class="s2">"鲜奶"</span> <span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_4</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="p">{</span> <span class="no">Kosong</span><span class="p">:</span> <span class="s2">"无糖"</span><span class="p">,</span> <span class="s2">"Siu Dai"</span><span class="p">:</span> <span class="s2">"少糖"</span><span class="p">,</span> <span class="s2">"Gah Dai"</span><span class="p">:</span> <span class="s2">"加糖"</span><span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_5</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="p">{</span> <span class="no">Gau</span><span class="p">:</span> <span class="s2">"浓缩"</span><span class="p">,</span> <span class="no">Po</span><span class="p">:</span> <span class="s2">"清淡"</span><span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
<span class="k">end</span>

<span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_6</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">extras</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
        <span class="p">{</span> <span class="no">Peng</span><span class="p">:</span> <span class="s2">"冰块"</span><span class="p">,</span> <span class="no">Bubble</span><span class="p">:</span> <span class="s2">"珍珠"</span><span class="p">,</span> <span class="no">Halia</span><span class="p">:</span> <span class="s2">"姜汁"</span> <span class="p">}[</span><span class="n">a</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
    <span class="k">end</span>
    <span class="n">extras</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="s2">"加</span><span class="si">#{</span><span class="n">extras</span><span class="p">.</span><span class="nf">join</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>我们规约最后一步的时候需要特殊处理鲜奶红茶和鲜奶咖啡这两个词语，因为一般我们直接叫奶茶和咖啡拿铁。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">production</span><span class="p">(</span><span class="ss">:Drink</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:merge</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"红茶"</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"鲜奶"</span>
        <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"奶茶"</span>
        <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">elsif</span> <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"咖啡"</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"鲜奶"</span>
        <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"咖啡拿铁"</span>
        <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">end</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_1</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_2</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_4</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_5</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_6</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="成果">成果</h2>

<p>最后我们得到了一个将马来西亚语的饮料名编译到汉语的编译（翻译）器。</p>

<p>完整代码如下：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"ebnf"</span>

<span class="no">TEA_GRAMMER</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOF</span><span class="sh">
Water     ::= "Kopi" | "Teh" | "Milo"
Sugar     ::= "Kosong" | "Siu Dai" | "Gah Dai"
Milk      ::= "O" | "C"
Thickness ::= "Po" | "Gau"
Extra     ::= "Peng" | "Bubble" | "Halia"
Upsize    ::= "Nga Lat"
Knot      ::= "Mati" | "Tepi"
Plastic   ::= "Ikat" Knot?
Takeout   ::= "Bungkus" Plastic?

Drink     ::= Takeout? Upsize? Water Milk? Sugar? Thickness? Extra*
</span><span class="no">EOF</span>

<span class="k">class</span> <span class="nc">MalayTea</span>
  <span class="kp">include</span> <span class="no">EBNF</span><span class="o">::</span><span class="no">PEG</span><span class="o">::</span><span class="no">Parser</span>
  <span class="nb">attr_reader</span> <span class="ss">:rules</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_1</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="s2">""</span>
    <span class="k">elsif</span> <span class="n">value</span><span class="p">.</span><span class="nf">length</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="s2">"外带"</span>
    <span class="k">else</span>
      <span class="s2">"外带</span><span class="si">#{</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">values</span><span class="p">.</span><span class="nf">join</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:Plastic</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="s2">""</span>
    <span class="k">elsif</span> <span class="n">value</span><span class="p">.</span><span class="nf">length</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="s2">"塑料袋装"</span>
    <span class="k">else</span>
      <span class="s2">"塑料袋装</span><span class="si">#{</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">values</span><span class="p">.</span><span class="nf">join</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:_Plastic_1</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="p">{</span> <span class="no">Mati</span><span class="p">:</span> <span class="s2">"打死结"</span><span class="p">,</span> <span class="no">Tepi</span><span class="p">:</span> <span class="s2">"侧面打结"</span><span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_2</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="s2">"大杯"</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:Water</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="p">{</span> <span class="no">Kopi</span><span class="p">:</span> <span class="s2">"咖啡"</span><span class="p">,</span> <span class="no">Teh</span><span class="p">:</span> <span class="s2">"红茶"</span><span class="p">,</span> <span class="no">Milo</span><span class="p">:</span> <span class="s2">"美禄"</span> <span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_3</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">"炼乳"</span> <span class="p">:</span> <span class="p">{</span> <span class="no">O</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="no">C</span><span class="p">:</span> <span class="s2">"鲜奶"</span> <span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_4</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="p">{</span> <span class="no">Kosong</span><span class="p">:</span> <span class="s2">"无糖"</span><span class="p">,</span> <span class="s2">"Siu Dai"</span><span class="p">:</span> <span class="s2">"少糖"</span><span class="p">,</span> <span class="s2">"Gah Dai"</span><span class="p">:</span> <span class="s2">"加糖"</span><span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_5</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="p">{</span> <span class="no">Gau</span><span class="p">:</span> <span class="s2">"浓缩"</span><span class="p">,</span> <span class="no">Po</span><span class="p">:</span> <span class="s2">"清淡"</span><span class="p">}[</span><span class="n">value</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:_Drink_6</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">extras</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
      <span class="p">{</span> <span class="no">Peng</span><span class="p">:</span> <span class="s2">"冰块"</span><span class="p">,</span> <span class="no">Bubble</span><span class="p">:</span> <span class="s2">"珍珠"</span><span class="p">,</span> <span class="no">Halia</span><span class="p">:</span> <span class="s2">"姜汁"</span> <span class="p">}[</span><span class="n">a</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
    <span class="k">end</span>
    <span class="n">extras</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="s2">""</span> <span class="p">:</span> <span class="s2">"加</span><span class="si">#{</span><span class="n">extras</span><span class="p">.</span><span class="nf">join</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">production</span><span class="p">(</span><span class="ss">:Drink</span><span class="p">,</span> <span class="ss">clear_packrat: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:merge</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"红茶"</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"鲜奶"</span>
      <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"奶茶"</span>
      <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">elsif</span> <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"咖啡"</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"鲜奶"</span>
      <span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"咖啡拿铁"</span>
      <span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">end</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_1</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_2</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_4</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_3</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_5</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:Water</span><span class="p">]</span><span class="si">}#{</span><span class="n">h</span><span class="p">[</span><span class="ss">:_Drink_6</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@rules</span> <span class="o">=</span> <span class="no">EBNF</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="no">TEA_GRAMMER</span><span class="p">).</span><span class="nf">make_peg</span><span class="p">.</span><span class="nf">ast</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="n">parse</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="ss">:Drink</span><span class="p">,</span> <span class="vi">@rules</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kp">loop</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="s2">"输入饮料名："</span>
  <span class="nb">print</span> <span class="s2">"&gt; "</span>
  <span class="nb">puts</span>  <span class="s2">"&lt; </span><span class="si">#{</span><span class="no">MalayTea</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">(</span><span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>我们来运行一下看看：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ruby main.rb
输入饮料名：
&gt; Bungkus Ikat Mati Nga Lat Kopi O Siu Dai Gau Peng Bubble
&lt; 外带塑料袋装打死结大杯少糖浓缩咖啡加冰块珍珠
</code></pre></div></div>

<p>欢迎大家带着这个程序去马来西亚／新加坡饮茶。</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/ruby" class="page__taxonomy-item p-category" rel="tag">Ruby</a><span class="sep">, </span>
    
      <a href="/tags/%E7%BC%96%E8%AF%91" class="page__taxonomy-item p-category" rel="tag">编译</a><span class="sep">, </span>
    
      <a href="/tags/%E8%AF%AD%E8%A8%80%E5%AD%A6" class="page__taxonomy-item p-category" rel="tag">语言学</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2021-07-05T12:44:49+08:00">July 5, 2021</time></p>

      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="https://coderemixer.com">Coderemixer 代码混音师</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
